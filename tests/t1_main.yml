---
- name: Pre-Test Scenario 1.0 - Initialize Docker containers
  hosts: localhost
  roles:
    - role: 'provision_docker'
      provision_docker__inventory:
        - name: 'test_system_groups_t1_centos7'
          image: 'tomashavlas/ansible-test:centos7'
          volumes:
            - '/sys/fs/cgroup:/sys/fs/cgroup:ro'
        - name: 'test_system_groups_t1_debian8'
          image: 'tomashavlas/ansible-test:debian8'
          volumes:
            - '/sys/fs/cgroup:/sys/fs/cgroup:ro'
  post_tasks:
    - name: Wait for SSH connection to docker containers
      wait_for:
        host: '{{ hostvars[item.name]["ansible_ssh_host"] }}'
        port: 22
        timeout: 30
        connect_timeout: 30
      with_items: '{{ provision_docker__inventory }}'
  tags: [ 'initialize-docker' ]

- name: Test Scenario 1.1 - Basic role functionality
  hosts: provision_docker__containers
  remote_user: 'root'
  pre_tasks:
    - name: Pre-Test - Create "remove me" test group
      group:
        name: 's1_removeme'
        state: 'present'
      changed_when: False
      tags: [ 'pre-test' ]
  post_tasks:
    - name: Acceptance Test - Verify simple group presence
      group:
        name: 's1_test'
        state: 'present'
      register: 'test_result'
      failed_when: (test_result|failed or test_result|changed)
      tags: [ 'acceptance-test' ]
    - name: Acceptance Test - Verify advanced group presence
      group:
        name: 's1_testadv'
        gid: 2100
        state: 'present'
      register: 'test_result'
      failed_when: (test_result|failed or test_result|changed)
      tags: [ 'acceptance-test' ]
    - name: Acceptance Test - Verify system group presence
      group:
        name: 's1_testsys'
        system: 'yes'
        state: 'present'
      register: 'test_result'
      failed_when: (test_result|failed or test_result|changed)
      tags: [ 'acceptance-test' ]
    - name: Acceptance Test - Verify disabled group absence
      group:
        name: 's1_disabled'
        state: 'absent'
      register: 'test_result'
      failed_when: (test_result|failed or test_result|changed)
      tags: [ 'acceptance-test' ]
    - name: Acceptance Test - Verify "remove me" group absence
      group:
        name: 's1_removeme'
        state: 'absent'
      register: 'test_result'
      failed_when: (test_result|failed or test_result|changed)
      tags: [ 'acceptance-test' ]
    - name: Acceptance Test - Verify "not disabled" group presence
      group:
        name: 's1_notdisabled'
        state: 'present'
      register: 'test_result'
      failed_when: (test_result|failed or test_result|changed)
      tags: [ 'acceptance-test' ]
    - name: Acceptance Test - Verify root group was not changed
      group:
        name: 'root'
        gid: 0
        state: 'present'
      register: 'test_result'
      failed_when: (test_result|failed or test_result|changed)
      tags: [ 'acceptance-test' ]
  roles:
      - role: 'system_groups'
        system_groups__list:
# test simple group
          - name: 's1_test'
# test advanced group
          - name: 's1_testadv'
            gid: 2100
# test system group
          - name: 's1_testsys'
            system: 'yes'
# test disabled group
          - name: 's1_disabled'
            disabled: True
          - name: 's1_removeme'
            disabled: True
# test not disabled group
          - name: 's1_notdisabled'
            disabled: False
# test root group
          - name: 'root'
            gid: 4000
